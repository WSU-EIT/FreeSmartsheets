# Templates/snapshot-workspace-template.yml
# Capture workspace diagnostics before/after your build/install steps.
# Works on Ubuntu agents (bash). Publishes artifacts for easy download.
# -------------------------------------------------------------------

parameters:
  # Toggle which snapshots you want to run
  enable_pre:  true
  enable_post: true

  # Where your checked-out code repo lands (Azure DevOps "checkout: CodeRepo path: CodeRepo")
  code_repo_root: '$(Pipeline.Workspace)/CodeRepo'

  # Optional subdirectory within the code repo to focus checks on
  code_subdir: 'FlexCRM.Plugin'

  # Artifact names (override per stage/job as needed)
  pre_artifact_name:  'prebuild-snapshot'
  post_artifact_name: 'postbuild-snapshot'

steps:
  # -------------------------
  # PREBUILD SNAPSHOT (before install/build)
  # -------------------------
  - ${{ if eq(parameters.enable_pre, true) }}:
    - script: |
        set -euo pipefail
        echo "Creating prebuild snapshot..."
        SNAP_DIR="$(Pipeline.Workspace)/_diagnostics"
        mkdir -p "$SNAP_DIR"

        {
          echo "=== ENV PATHS ==="
          echo "Agent.BuildDirectory: $(Agent.BuildDirectory)"
          echo "Build.SourcesDirectory: $(Build.SourcesDirectory)"
          echo "Pipeline.Workspace: $(Pipeline.Workspace)"
          echo

          echo "=== TOP OF WORKSPACE ==="
          ls -la "$(Pipeline.Workspace)" || true
          echo

          echo "=== TREE (depth 2) UNDER CodeRepo ==="
          if [ -d "${{ parameters.code_repo_root }}" ]; then
            find "${{ parameters.code_repo_root }}" -maxdepth 2 -print
          else
            echo "MISSING: ${{ parameters.code_repo_root }}"
          fi
          echo

          echo "=== DISK USAGE ==="
          df -h
          du -h -d1 "$(Pipeline.Workspace)" || true
        } > "$SNAP_DIR/prebuild_tree.txt"

        echo "Prebuild snapshot saved to $SNAP_DIR/prebuild_tree.txt"
      displayName: "Create PREBUILD file listing"

    - task: PublishPipelineArtifact@1
      displayName: "Publish PREBUILD snapshot (workspace)"
      inputs:
        targetPath: '$(Pipeline.Workspace)'
        artifact:   '${{ parameters.pre_artifact_name }}'
        publishLocation: 'pipeline'

  # -------------------------
  # POSTBUILD SNAPSHOT (after install/build)
  # -------------------------
  - ${{ if eq(parameters.enable_post, true) }}:
    - script: |
        set -euo pipefail
        echo "Creating postbuild snapshot..."
        SNAP_DIR="$(Pipeline.Workspace)/_diagnostics"
        mkdir -p "$SNAP_DIR"

        {
          echo "=== WHERE AM I ==="
          pwd
          echo

          echo "=== TREE (depth 2) UNDER CodeRepo ==="
          if [ -d "${{ parameters.code_repo_root }}" ]; then
            find "${{ parameters.code_repo_root }}" -maxdepth 2 -print
          else
            echo "MISSING: ${{ parameters.code_repo_root }}"
          fi
          echo

          # Resolve the specific code directory we care about
          CODE_DIR="${{ parameters.code_repo_root }}/${{ parameters.code_subdir }}"
          if [ ! -d "$CODE_DIR" ]; then
            ALT_DIR="$(Build.SourcesDirectory)/CodeRepo/${{ parameters.code_subdir }}"
            [ -d "$ALT_DIR" ] && CODE_DIR="$ALT_DIR"
          fi

          echo "Resolved CODE_DIR: $CODE_DIR"

          if [ -d "$CODE_DIR" ]; then
            cd "$CODE_DIR"

            echo "=== BUILD ARTIFACT DIR CHECKS ==="
            for d in dist build lib .next out; do
              if [ -d "$d" ]; then
                echo "FOUND DIR: $d"
                ls -la "$d" || true
              else
                echo "MISSING DIR: $d"
              fi
            done

            echo
            echo "=== NPM LOGS ==="
            ls -la npm-debug.log 2>/dev/null || echo "No npm-debug.log found."
          else
            echo "Flex plugin directory not found: $CODE_DIR"
          fi
          echo

          echo "=== DISK USAGE ==="
          df -h
          du -h -d1 "$(Pipeline.Workspace)" || true
        } > "$SNAP_DIR/postbuild_tree.txt"

        echo "Postbuild snapshot saved to $SNAP_DIR/postbuild_tree.txt"
      displayName: "Create POSTBUILD file listing"

    - task: PublishPipelineArtifact@1
      displayName: "Publish POSTBUILD snapshot (workspace)"
      inputs:
        targetPath: '$(Pipeline.Workspace)'
        artifact:   '${{ parameters.post_artifact_name }}'
        publishLocation: 'pipeline'
