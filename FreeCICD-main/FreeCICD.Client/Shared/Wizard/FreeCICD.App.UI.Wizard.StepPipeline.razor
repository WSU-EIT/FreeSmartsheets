@* WizardStepPipeline.razor - Pipeline selection/creation step *@

<label class="form-label">Select Existing Pipeline:</label>
<select class="form-select" @onchange="OnPipelineChanged" disabled="@IsDisabled">
    <option value="">-- Select Pipeline or Create New --</option>
    @foreach (var group in PipelineDefinitions.GroupBy(p => p.Path).OrderBy(g => g.Key))
    {
        <optgroup label="@group.Key">
            @foreach (var pipe in group.OrderBy(p => p.Name))
            {
                <option value="@pipe.Id" selected="@(pipe.Id == SelectedPipelineId ? "selected" : null)">@pipe.Name</option>
            }
        </optgroup>
    }
</select>

@if (SelectedPipelineId <= 0 || SelectedPipelineId == null)
{
    <div class="mt-3">
        <label class="form-label">New Pipeline Name:</label>
        <input type="text" 
               class="form-control" 
               value="@NewPipelineName"
               @oninput="HandlePipelineNameInput"
               placeholder="Enter pipeline name" />
    </div>
}
else
{
    var pipeline = PipelineDefinitions?.FirstOrDefault(p => p.Id == SelectedPipelineId);
    if (pipeline != null)
    {
        <div class="mt-3">
            <p><strong>Pipeline Name:</strong> @pipeline.Name</p>
            <p><strong>Pipeline Id:</strong> @pipeline.Id</p>
            <p><strong>YML File:</strong> @pipeline.YamlFileName</p>
        </div>
    }
}

@code {
    [Parameter] public List<DataObjects.DevopsPipelineDefinition> PipelineDefinitions { get; set; } = new();
    [Parameter] public int? SelectedPipelineId { get; set; }
    [Parameter] public string NewPipelineName { get; set; } = "";
    [Parameter] public EventCallback<string> OnNewPipelineNameChanged { get; set; }
    [Parameter] public bool IsDisabled { get; set; }
    [Parameter] public EventCallback<ChangeEventArgs> OnPipelineChanged { get; set; }

    private async Task HandlePipelineNameInput(ChangeEventArgs e)
    {
        var value = e.Value?.ToString() ?? "";
        await OnNewPipelineNameChanged.InvokeAsync(value);
    }
}
