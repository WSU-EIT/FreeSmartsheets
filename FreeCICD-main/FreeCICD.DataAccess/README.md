# FreeCICD.DataAccess

## Overview

The `FreeCICD.DataAccess` project is the **business logic layer** containing all data operations, authentication, encryption, integrations, and cross-cutting concerns. It implements the `IDataAccess` interface and uses Entity Framework Core for persistence.

---

## Project Structure

```
FreeCICD.DataAccess/
??? DataAccess.cs                  # Core initialization and configuration
??? DataAccess.ActiveDirectory.cs  # LDAP/AD integration
??? DataAccess.Ajax.cs             # AJAX endpoint helpers
??? DataAccess.App.cs              # App-specific extension point
??? DataAccess.App.FreeCICD.cs     # Azure DevOps & Pipeline Dashboard operations
??? DataAccess.ApplicationSettings.cs # Application settings management
??? DataAccess.Authenticate.cs     # Authentication logic
??? DataAccess.CSharpCode.cs       # Dynamic C# compilation
??? DataAccess.Departments.cs      # Department CRUD
??? DataAccess.Disposable.cs       # IDisposable implementation
??? DataAccess.Encryption.cs       # Encryption utilities
??? DataAccess.FileStorage.cs      # File management
??? DataAccess.JWT.cs              # JWT token generation/validation
??? DataAccess.Language.cs         # Internationalization
??? DataAccess.Migrations.cs       # Database migration runner
??? DataAccess.Plugins.cs          # Plugin system integration
??? DataAccess.SeedTestData.cs     # Initial data seeding
??? DataAccess.Settings.cs         # Settings key-value store
??? DataAccess.SignalR.cs          # Real-time communication
??? DataAccess.Tags.cs             # Tag system operations
??? DataAccess.Tenants.cs          # Multi-tenant operations
??? DataAccess.UDFLabels.cs        # User-defined fields
??? DataAccess.UserGroups.cs       # User group management
??? DataAccess.Users.cs            # User CRUD operations
??? DataAccess.Utilities.cs        # Utility methods
??? DataMigrations.MySQL.cs        # MySQL-specific migrations
??? DataMigrations.PostgreSQL.cs   # PostgreSQL-specific migrations
??? DataMigrations.SQLite.cs       # SQLite-specific migrations
??? DataMigrations.SQLServer.cs    # SQL Server-specific migrations
??? GlobalUsings.cs                # Global using statements
??? GraphAPI.cs                    # Microsoft Graph integration
??? GraphAPI.App.cs                # App-specific Graph extensions
??? RandomPasswordGenerator.cs     # Password generation
??? RandomPasswordGenerator.App.cs # App-specific password rules
??? Utilities.cs                   # Static utility methods
??? Utilities.App.cs               # App-specific utilities
??? FreeCICD.DataAccess.csproj     # Project file
```

---

## Architecture Diagram

```
???????????????????????????????????????????????????????????????????????????????
?                         DATA ACCESS LAYER                                   ?
???????????????????????????????????????????????????????????????????????????????
?                                                                             ?
?  ?????????????????????????????????????????????????????????????????????????  ?
?  ?                        IDataAccess Interface                          ?  ?
?  ?  ?????????????  ?????????????  ?????????????  ?????????????          ?  ?
?  ?  ?Authenticate?  ?   Users   ?  ?  Tenants  ?  ?Departments?          ?  ?
?  ?  ? GetUser   ?  ? SaveUser  ?  ? GetTenant ?  ? SaveDept  ?          ?  ?
?  ?  ? GetToken  ?  ? DeleteUser?  ? SaveTenant?  ? GetDepts  ?          ?  ?
?  ?  ?????????????  ?????????????  ?????????????  ?????????????          ?  ?
?  ?                                                                       ?  ?
?  ?  ?????????????  ?????????????  ?????????????  ?????????????          ?  ?
?  ?  ?FileStorage?  ? Settings  ?  ?  SignalR  ?  ?  Plugins  ?          ?  ?
?  ?  ? SaveFile  ?  ? GetSetting?  ?SignalRUpdate? ? GetPlugins?          ?  ?
?  ?  ? GetFile   ?  ? SaveSetting? ?           ?  ? RunPlugin ?          ?  ?
?  ?  ?????????????  ?????????????  ?????????????  ?????????????          ?  ?
?  ?                                                                       ?  ?
?  ?  ??????????????????????????????????????????????????????????????????? ?  ?
?  ?  ?              Azure DevOps / Pipeline Dashboard                  ? ?  ?
?  ?  ?  GetPipelineDashboardAsync    ?  ParsePipelineYaml              ? ?  ?
?  ?  ?  GetPipelineRunsForDashboard  ?  GetDevOpsProjects/Repos/Branch ? ?  ?
?  ?  ?  GetPipelineYamlContent       ?  CreateOrUpdateDevopsPipeline   ? ?  ?
?  ?  ??????????????????????????????????????????????????????????????????? ?  ?
?  ?????????????????????????????????????????????????????????????????????????  ?
?                                    ?                                        ?
?  ?????????????????????????????????????????????????????????????????????????  ?
?  ?                      DataAccess Implementation                        ?  ?
?  ?                                                                       ?  ?
?  ?  ?????????????????????????????????????????????????????????????????   ?  ?
?  ?  ?                    Cross-Cutting Concerns                     ?   ?  ?
?  ?  ?  ?????????????  ?????????????  ?????????????  ?????????????   ?   ?  ?
?  ?  ?  ?Encryption ?  ?    JWT    ?  ?  Hashing  ?  ?  Caching  ?   ?   ?  ?
?  ?  ?  ?????????????  ?????????????  ?????????????  ?????????????   ?   ?  ?
?  ?  ?????????????????????????????????????????????????????????????????   ?  ?
?  ?                                                                       ?  ?
?  ?  ?????????????????????????????????????????????????????????????????   ?  ?
?  ?  ?                      External Integrations                    ?   ?  ?
?  ?  ?  ?????????????  ?????????????  ?????????????  ?????????????   ?   ?  ?
?  ?  ?  ?   LDAP    ?  ?Graph API  ?  ?Azure DevOps? ?  Plugins  ?   ?   ?  ?
?  ?  ?  ?????????????  ?????????????  ?????????????  ?????????????   ?   ?  ?
?  ?  ?????????????????????????????????????????????????????????????????   ?  ?
?  ?????????????????????????????????????????????????????????????????????????  ?
?                                    ?                                        ?
?  ?????????????????????????????????????????????????????????????????????????  ?
?  ?                        EFDataModel (DbContext)                        ?  ?
?  ?              FreeCICD.EFModels - Entity Framework Core                ?  ?
?  ?????????????????????????????????????????????????????????????????????????  ?
?                                                                             ?
???????????????????????????????????????????????????????????????????????????????
```

---

## Pipeline Dashboard Operations

The `DataAccess.App.FreeCICD.cs` file contains Azure DevOps integration methods:

### Pipeline Dashboard Methods

```csharp
// Get all pipelines with status, runs, and variable groups
Task<DataObjects.PipelineDashboardResponse> GetPipelineDashboardAsync(
    string pat, string orgName, string projectId, string? connectionId = null);

// Get recent runs for a specific pipeline
Task<DataObjects.PipelineRunsResponse> GetPipelineRunsForDashboardAsync(
    string pat, string orgName, string projectId, int pipelineId, int top = 5, string? connectionId = null);

// Get YAML content for a pipeline
Task<DataObjects.PipelineYamlResponse> GetPipelineYamlContentAsync(
    string pat, string orgName, string projectId, int pipelineId, string? connectionId = null);

// Parse YAML to extract settings for wizard import
DataObjects.ParsedPipelineSettings ParsePipelineYaml(
    string yamlContent, int? pipelineId = null, string? pipelineName = null, string? pipelinePath = null);
```

### Pipeline Dashboard Data Flow

```
???????????????????????????????????????????????????????????????????????????????
?                    PIPELINE DASHBOARD DATA FLOW                             ?
???????????????????????????????????????????????????????????????????????????????
?                                                                             ?
?  Azure DevOps API                                                           ?
?       ?                                                                     ?
?       ?                                                                     ?
?  BuildHttpClient.GetDefinitionsAsync()                                      ?
?       ?                                                                     ?
?       ???> For each pipeline:                                               ?
?       ?    ?                                                                ?
?       ?    ??> GetDefinitionAsync() ??> Name, Path, Repo, DefaultBranch    ?
?       ?    ?                                                                ?
?       ?    ??> GetBuildsAsync(top: 1) ??> LastRunStatus, LastRunResult     ?
?       ?    ?                          ???> TriggerBranch (SourceBranch)     ?
?       ?    ?                                                                ?
?       ?    ??> GitClient.GetItemAsync(yaml) ??> ParsePipelineYaml()        ?
?       ?                                    ???> VariableGroups             ?
?       ?                                                                     ?
?       ?                                                                     ?
?  PipelineDashboardResponse                                                  ?
?       ?                                                                     ?
?       ???> Pipelines[]                                                      ?
?            ?? Id, Name, Path                                                ?
?            ?? RepositoryName                                                ?
?            ?? DefaultBranch (repo default)                                  ?
?            ?? TriggerBranch (from last build) ? PREFERRED FOR DISPLAY       ?
?            ?? LastRunStatus, LastRunResult, LastRunTime                     ?
?            ?? YamlFileName                                                  ?
?            ?? VariableGroups[]                                              ?
?                ?? Name, Environment                                         ?
?                ?? Id, VariableCount                                         ?
?                ?? ResourceUrl (link to Azure DevOps)                        ?
?                                                                             ?
???????????????????????????????????????????????????????????????????????????????
```

### YAML Parsing

The `ParsePipelineYaml` method extracts settings from Azure DevOps pipeline YAML:

```csharp
// Parses:
// - Trigger branch from 'trigger:' section
// - CI_ProjectName and CI_BUILD_CsProjectPath variables
// - Environment-specific variables (CI_{ENV}_VariableGroup, etc.)
// - Deploy stages (Deploy{ENV}Stage)
// - Repository resources
```

---

## Authentication Flow

```
???????????????????????????????????????????????????????????????????????????????
?                         AUTHENTICATION FLOW                                 ?
???????????????????????????????????????????????????????????????????????????????

    Client                    DataAccess                    Database
      ?                           ?                            ?
      ?  Authenticate(creds)      ?                            ?
      ? ????????????????????????> ?                            ?
      ?                           ?                            ?
      ?                           ?  Find User by Email/Username
      ?                           ? ??????????????????????????> ?
      ?                           ? <?????????????????????????? ?
      ?                           ?                            ?
      ?                           ?  Check Lockout Status      ?
      ?                           ?  (FailedLoginAttempts,     ?
      ?                           ?   LastLockoutDate)         ?
      ?                           ?                            ?
      ?                     ?????????????                      ?
      ?                     ?  Locked?  ?                      ?
      ?                     ?????????????                      ?
      ?                           ?                            ?
      ?          ???????????????????????????????????           ?
      ?         YES                               NO           ?
      ?          ?                                 ?           ?
      ?          ?                                 ?           ?
      ?   Return Error              Validate Password          ?
      ?   "Account Locked"          (HashPasswordValidate)     ?
      ?                                            ?           ?
      ?                     ????????????????????????????????????
      ?                     ?                              ?   ?
      ?                   VALID                        INVALID ?
      ?                     ?                              ?   ?
      ?                     ?                              ?   ?
      ?              Clear Lockout               Increment Failed
      ?              Generate JWT                Update Lockout ?
      ?              Update LastLogin                      ?   ?
      ?                     ?                              ?   ?
      ? <?????????????????? ?                              ?   ?
      ?   User + AuthToken                                 ?   ?
      ?                                                    ?   ?
      ? <?????????????????????????????????????????????????? ?   ?
      ?   Error: Invalid credentials                           ?
      ?                                                        ?

???????????????????????????????????????????????????????????????????????????????
```

---

## Security Features

### Password Hashing

```csharp
// Password hashing uses BCrypt
string hashedPassword = HashPassword(plainTextPassword);
bool isValid = HashPasswordValidate(plainTextPassword, hashedPassword);
```

### Account Lockout

```
?????????????????????????????????????????????????????????????????????????
?                    ACCOUNT LOCKOUT POLICY                             ?
?????????????????????????????????????????????????????????????????????????
?  Max Failed Attempts:  5                                              ?
?  Lockout Duration:     10 minutes                                     ?
?                                                                       ?
?  After 5 failed attempts:                                             ?
?  ? LastLockoutDate = DateTime.UtcNow                                  ?
?  ? Account locked for 10 minutes                                      ?
?                                                                       ?
?  On successful login:                                                 ?
?  ? FailedLoginAttempts = null                                         ?
?  ? LastLockoutDate = null                                             ?
?????????????????????????????????????????????????????????????????????????
```

### JWT Token Generation

```csharp
// Token includes:
// - TenantId
// - UserId
// - Fingerprint (client identifier)
// - Sudo flag (admin impersonation)
string token = GetUserToken(tenantId, userId, fingerprint, isSudo);
```

---

## Azure DevOps Integration

### Connection Management

```csharp
private VssConnection CreateConnection(string pat, string orgName)
{
    var collectionUri = new Uri($"https://dev.azure.com/{orgName}");
    var credentials = new VssBasicCredential(string.Empty, pat);
    return new VssConnection(collectionUri, credentials);
}
```

### Available Azure DevOps Methods

| Method | Purpose |
|--------|---------|
| `GetDevOpsProjectsAsync` | List all projects in organization |
| `GetDevOpsReposAsync` | List repositories in a project |
| `GetDevOpsBranchesAsync` | List branches in a repository |
| `GetDevOpsFilesAsync` | List files in a branch |
| `GetDevOpsPipelinesAsync` | List pipeline definitions |
| `GetDevOpsPipeline` | Get single pipeline details |
| `GetPipelineRuns` | Get pipeline run history |
| `GetProjectVariableGroupsAsync` | List variable groups |
| `CreateVariableGroup` | Create new variable group |
| `UpdateVariableGroup` | Update existing variable group |
| `GetGitFile` | Get file content from repo |
| `CreateOrUpdateGitFile` | Push file to repository |
| `GenerateYmlFileContents` | Generate pipeline YAML from template |
| `CreateOrUpdateDevopsPipeline` | Create or update pipeline definition |

---

## Key Interface Methods

### IDataAccess Interface

```csharp
public partial interface IDataAccess
{
    // Authentication
    Task<DataObjects.User> Authenticate(DataObjects.Authenticate authentication, string fingerprint);
    string GetUserToken(Guid tenantId, Guid userId, string fingerprint, bool sudo);
    
    // Users
    Task<DataObjects.User> GetUser(Guid userId);
    Task<DataObjects.User> SaveUser(DataObjects.User user, DataObjects.User currentUser);
    Task<DataObjects.BooleanResponse> DeleteUser(Guid userId, DataObjects.User currentUser);
    
    // Tenants
    Task<DataObjects.Tenant> GetTenant(Guid tenantId);
    Task<DataObjects.Tenant> SaveTenant(DataObjects.Tenant tenant, DataObjects.User currentUser);
    
    // Files
    Task<DataObjects.FileStorage> GetFile(Guid fileId);
    Task<DataObjects.FileStorage> SaveFile(DataObjects.FileStorage file, DataObjects.User currentUser);
    
    // Settings
    Task<DataObjects.Setting> GetSetting(string settingName, Guid? tenantId, Guid? userId);
    Task<DataObjects.Setting> SaveSetting(DataObjects.Setting setting, DataObjects.User currentUser);
    
    // SignalR
    Task SignalRUpdate(DataObjects.SignalRUpdate update);
    
    // Plugins
    Task<List<Plugins.Plugin>> GetPlugins(Guid tenantId);
    
    // Pipeline Dashboard (FreeCICD-specific)
    Task<DataObjects.PipelineDashboardResponse> GetPipelineDashboardAsync(...);
    Task<DataObjects.PipelineRunsResponse> GetPipelineRunsForDashboardAsync(...);
    Task<DataObjects.PipelineYamlResponse> GetPipelineYamlContentAsync(...);
    DataObjects.ParsedPipelineSettings ParsePipelineYaml(...);
}
```

---

## Dependencies

```xml
<ItemGroup>
  <!-- Azure -->
  <PackageReference Include="Azure.Identity" Version="1.17.1" />
  
  <!-- Azure DevOps SDK -->
  <PackageReference Include="Microsoft.TeamFoundationServer.Client" Version="19.240.0" />
  
  <!-- YAML Parsing -->
  <PackageReference Include="YamlDotNet" Version="16.3.0" />
  
  <!-- Data Processing -->
  <PackageReference Include="Brad.Wickett_Sql2LINQ" Version="3.0.1" />
  <PackageReference Include="CsvHelper" Version="33.1.0" />
  
  <!-- Security -->
  <PackageReference Include="JWTHelpers" Version="1.0.1" />
  
  <!-- Microsoft Graph -->
  <PackageReference Include="Microsoft.Graph" Version="5.97.0" />
  
  <!-- Blazor -->
  <PackageReference Include="Microsoft.AspNetCore.Components.WebAssembly.Server" Version="10.0.0" />
  
  <!-- LDAP -->
  <PackageReference Include="Novell.Directory.Ldap.NETStandard" Version="4.0.0" />
  
  <!-- PDF Generation -->
  <PackageReference Include="QuestPDF" Version="2025.7.4" />
</ItemGroup>
```

---

## Recent Changes

### December 2025 - TriggerBranch for Pipeline Dashboard

Updated `GetPipelineDashboardAsync` to populate `TriggerBranch` from the latest build's `SourceBranch`. This shows the actual branch that triggered the most recent build, which is more accurate than `DefaultBranch` (the repository's default).

```csharp
// Inside GetPipelineDashboardAsync()
var latestBuild = builds[0];
item.TriggerBranch = latestBuild.SourceBranch;  // NEW
```

See: [022-Branch-Display-Fix-Sanity-Check.md](../docs/022-Branch-Display-Fix-Sanity-Check.md)

---

## Best Practices

1. **Use async/await**: All data operations should be async
2. **Filter by TenantId**: Every query must be tenant-scoped
3. **Check soft deletes**: Filter `Deleted == false` by default
4. **Use CurrentUser**: Pass current user for audit trails
5. **Handle exceptions**: Catch and log all database errors
6. **Use SignalR updates**: Broadcast changes for real-time UI
7. **Extend via App files**: Don't modify core DataAccess files
8. **Cache connections**: Reuse VssConnection for Azure DevOps calls

---

## Security Checklist

- [ ] All passwords are hashed (never stored plaintext)
- [ ] Account lockout is enforced after failed attempts
- [ ] JWT tokens include fingerprint for binding
- [ ] Sensitive settings are encrypted
- [ ] Tenant isolation is enforced on all queries
- [ ] Admin operations require Admin flag
- [ ] Sudo login is audited
- [ ] Azure DevOps PAT is not logged or exposed
